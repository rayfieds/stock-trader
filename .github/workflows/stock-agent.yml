name: Stock Agent

on:
  schedule:
    # Morning digest: 9:30 AM ET = 14:30 UTC (Mon-Fri)
    - cron: '30 14 * * 1-5'
    # Afternoon digest: 3:00 PM ET = 20:00 UTC (Mon-Fri)
    - cron: '0 20 * * 1-5'
    # Emergency checks: Every 30 min from 10 AM - 4 PM ET (14:00-20:00 UTC)
    - cron: '0,30 14-19 * * 1-5'
  workflow_dispatch: # Allows manual trigger from Actions tab
    inputs:
      job_type:
        description: 'Which job to run'
        required: true
        default: 'morning'
        type: choice
        options:
          - morning
          - afternoon
          - emergency

jobs:
  morning-digest:
    if: (github.event.schedule == '30 14 * * 1-5') || (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'morning')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run morning digest
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: python main.py morning

  afternoon-digest:
    if: (github.event.schedule == '0 20 * * 1-5') || (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'afternoon')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Run afternoon digest
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: python main.py afternoon

  emergency-check:
    if: (github.event.schedule == '0,30 14-19 * * 1-5') || (github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'emergency')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: pip install -r requirements.txt
      
      - name: Check for emergencies
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
        run: python check_emergencies.py test